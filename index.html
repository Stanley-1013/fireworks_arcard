<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AR Yka - Fireworks AR Card</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/supermedium/aframe-particleplayer-component@1.0.9/dist/aframe-particleplayer-component.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    
    #hud {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 14px;
      z-index: 1000;
      text-align: center;
    }
    
    #loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 20px;
      border-radius: 10px;
      font-size: 16px;
      z-index: 1001;
      text-align: center;
    }
    
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loading">
    <div>Ë-...</div>
    <div style="margin-top: 10px; font-size: 12px;">ËA1ø_
P</div>
  </div>
  
  <!-- HUD Status -->
  <div id="hud">
    Ë-...
  </div>
  
  <!-- A-Frame AR Scene -->
  <a-scene 
    mindar-image="imageTargetSrc: ./assets/card.mind; filterMinCF: 0.0001; filterBeta: 0.01;" 
    color-space="sRGB" 
    renderer="colorManagement: true, physicallyCorrectLights: true"
    vr-mode-ui="enabled: false" 
    device-orientation-permission-ui="enabled: false">
    
    <!-- Assets -->
    <a-assets>
      <a-asset-item id="particlesJson" src="./assets/particles-fireworks.json"></a-asset-item>
      <img id="particleTexture" src="./assets/sprite.png" crossorigin="anonymous">
    </a-assets>
    
    <!-- Camera -->
    <a-camera position="0 0 0" look-controls="enabled: false" cursor="fuse: false; rayOrigin: mouse;" raycaster="far: 10000; objects: .clickable"></a-camera>
    
    <!-- AR Target -->
    <a-entity mindar-image-target="targetIndex: 0" visible="false" id="target">
      <!-- Fireworks Particle System -->
      <a-entity 
        id="fireworks"
        particleplayer="
          src: #particlesJson; 
          texture: #particleTexture; 
          loop: true;
          scale: 1.0;
          count: 100;
        "
        position="0 0.5 0"
        visible="false">
      </a-entity>
      
      <!-- Greeting Text -->
      <a-text 
        id="greeting-text"
        value="—È@ÅºÀë!"
        position="0 -0.5 0"
        align="center"
        color="white"
        font="kelsonsans"
        width="8"
        geometry="primitive: plane; width: auto; height: auto"
        material="color: black; opacity: 0.7"
        visible="false">
      </a-text>
    </a-entity>
  </a-scene>

  <script>
    // Global variables
    let arSystem;
    let targetEntity;
    let fireworksEntity;
    let greetingText;
    let hudElement = document.getElementById('hud');
    let loadingElement = document.getElementById('loading');
    let isTargetFound = false;
    
    // Parse URL parameters for custom message
    function getURLParameter(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }
    
    // Update greeting text based on URL parameter
    function updateGreetingText() {
      const customMessage = getURLParameter('msg');
      const greetingText = document.getElementById('greeting-text');
      
      if (customMessage) {
        greetingText.setAttribute('value', decodeURIComponent(customMessage));
      }
    }
    
    // Update HUD status
    function updateHUD(message) {
      hudElement.textContent = message;
    }
    
    // Hide loading screen
    function hideLoading() {
      loadingElement.classList.add('hidden');
    }
    
    // Show loading screen
    function showLoading(message = 'Ë-...') {
      loadingElement.querySelector('div').textContent = message;
      loadingElement.classList.remove('hidden');
    }
    
    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
      // Update greeting text from URL parameter
      updateGreetingText();
      
      // Get references to entities
      const sceneEl = document.querySelector('a-scene');
      targetEntity = document.getElementById('target');
      fireworksEntity = document.getElementById('fireworks');
      greetingText = document.getElementById('greeting-text');
      
      // Wait for A-Frame to load
      sceneEl.addEventListener('loaded', function() {
        console.log('A-Frame scene loaded');
        
        // Initialize MindAR
        arSystem = sceneEl.systems['mindar-image'];
        
        if (arSystem) {
          console.log('MindAR system found');
          
          // MindAR events
          arSystem.el.addEventListener('arReady', function() {
            console.log('AR Ready');
            hideLoading();
            updateHUD('AR 1ÒË–aG');
          });
          
          arSystem.el.addEventListener('arError', function(event) {
            console.error('AR Error:', event.detail);
            updateHUD('AR /¤ËÍ°tb');
            showLoading('AR Ë1W');
          });
          
          // Target detection events
          targetEntity.addEventListener('targetFound', function() {
            console.log('Target found!');
            isTargetFound = true;
            updateHUD('òu,0î <¯');
            
            // Show fireworks and greeting
            fireworksEntity.setAttribute('visible', true);
            greetingText.setAttribute('visible', true);
            targetEntity.setAttribute('visible', true);
            
            // Start particle animation
            const particlePlayer = fireworksEntity.components.particleplayer;
            if (particlePlayer) {
              particlePlayer.playAnimation();
            }
          });
          
          targetEntity.addEventListener('targetLost', function() {
            console.log('Target lost!');
            isTargetFound = false;
            updateHUD('îz1ËÍ°–');
            
            // Hide elements
            fireworksEntity.setAttribute('visible', false);
            greetingText.setAttribute('visible', false);
            targetEntity.setAttribute('visible', false);
          });
          
        } else {
          console.error('MindAR system not found');
          updateHUD('MindAR ûq*~0');
          showLoading('ûq	e1W');
        }
      });
      
      // Handle camera permission
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(function(stream) {
          console.log('Camera permission granted');
          stream.getTracks().forEach(track => track.stop()); // Stop the stream as A-Frame will handle it
        })
        .catch(function(err) {
          console.error('Camera permission denied:', err);
          updateHUD('ø_
P«ÒU');
          showLoading('ËA1ø_
P&Í°t');
        });
    });
    
    // Debug functions (can be called from browser console)
    window.debugAR = {
      getTargetStatus: () => isTargetFound,
      getARSystem: () => arSystem,
      showFireworks: () => {
        if (fireworksEntity) {
          fireworksEntity.setAttribute('visible', true);
          const particlePlayer = fireworksEntity.components.particleplayer;
          if (particlePlayer) {
            particlePlayer.playAnimation();
          }
        }
      },
      hideFireworks: () => {
        if (fireworksEntity) {
          fireworksEntity.setAttribute('visible', false);
        }
      }
    };
  </script>
</body>
</html>